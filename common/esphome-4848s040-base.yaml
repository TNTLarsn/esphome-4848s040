esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  # Automatically add the mac address to the name
  # so you can use a single firmware for all devices
  name_add_mac_suffix: true
  project:
    name: ${project_name}
    version: ${project_version} # replaced by release workflow with the tagged version

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: esp-idf

# To be able to get logs from the device via serial and api.
logger:
  level: ${log_level}

# API is a requirement of the dashboard import.
api:

# OTA is required for Over-the-Air updating
# - esphome platform: For OTA via ESPHome Dashboard
# - http_request platform: For managed firmware updates via manifest.json

ota:
  - platform: esphome
    id: ota_esphome
  - platform: http_request
    id: ota_http_request

http_request:

wifi:
  fast_connect: ${hidden_ssid}
  # Set up a wifi access point using the device name above
  ap:
   
improv_serial:
  
# In combination with the `ap` this allows the user
# to provision wifi credentials to the device.
captive_portal:
  
button:
  - platform: restart
    id: restart_internal
    entity_category: config
    internal: true
  - platform: safe_mode
    internal: false
    name: Safe mode
    entity_category: config
    disabled_by_default: True
  - platform: factory_reset
    id: "factory_reset_button"
    internal: True
  - platform: template
    id: update_firmware
    name: Update Firmware
    entity_category: "config"
    on_press: 
      then:
        - ota.http_request.flash:
            md5_url: https://github.com/tntlarsn/esphome-4848s040/releases/latest/download/esphome-4848s040-esp32s3.ota.bin.md5?raw=true
            url: https://github.com/tntlarsn/esphome-4848s040/releases/latest/download/esphome-4848s040-esp32s3.ota.bin?raw=true           

sensor:
  - platform: uptime
    id: uptime_internal
    entity_category: "diagnostic"
    device_class: "duration"
    unit_of_measurement: "s"

  - platform: wifi_signal # Reports the WiFi signal strength/RSSI in dB
    name: "WiFi Signal dBm"
    id: wifi_signal_db
    update_interval: 60s
    entity_category: "diagnostic"
    unit_of_measurement: "dBm"
    device_class: "signal_strength"

  - platform: copy # Reports the WiFi signal strength in %
    source_id: wifi_signal_db
    name: "WiFi Percentage"
    filters:
      - lambda: return min(max(2 * (x + 100.0), 0.0), 100.0);
    unit_of_measurement: "%"
    entity_category: "diagnostic"
    device_class: "signal_strength"

text_sensor:
  - platform: wifi_info
    ip_address:
      name: IP Address
    ssid:
      name: SSID
    bssid:
      name: BSSID
    mac_address:
      name: Mac Wifi Address
    scan_results:
      name: Latest Scan Results
    dns_address:
      name: DNS Address